<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AluIA - Supporto Psicologico</title>
  <script src="./edv.js" defer></script>
  <style>
    :root {
      color-scheme: light dark;
      --bg-gradient: radial-gradient(circle at 0% 0%, rgba(118, 174, 241, 0.25), transparent 55%),
        radial-gradient(circle at 85% 0%, rgba(255, 214, 165, 0.28), transparent 60%),
        linear-gradient(135deg, #eaf2ff 0%, #f9fbff 100%);
      --card-bg: rgba(255, 255, 255, 0.96);
      --card-border: rgba(255, 255, 255, 0.55);
      --text-main: #23344a;
      --text-soft: #6f7d90;
      --accent: #4a90e2;
      --accent-soft: rgba(74, 144, 226, 0.12);
      --accent-strong: #1b68c6;
      --danger: #d32f2f;
      --success: #2ecc71;
      --warning: #ff9500;
      --shadow-soft: 0 12px 36px rgba(31, 64, 102, 0.16);
    }

    body.dark-mode {
      --bg-gradient: radial-gradient(circle at 0% 0%, rgba(74, 137, 220, 0.23), transparent 55%),
        radial-gradient(circle at 100% 10%, rgba(105, 96, 236, 0.22), transparent 65%),
        linear-gradient(135deg, #1f2933 0%, #141c26 100%);
      --card-bg: rgba(31, 43, 58, 0.92);
      --card-border: rgba(148, 176, 210, 0.15);
      --text-main: #e8f1ff;
      --text-soft: #b3c1d3;
      --accent: #74b9ff;
      --accent-soft: rgba(116, 185, 255, 0.18);
      --accent-strong: #4aa3ff;
      --danger: #ef5350;
      --success: #6dd3a3;
      --warning: #f5ab35;
      --shadow-soft: 0 18px 48px rgba(10, 15, 24, 0.45);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', 'San Francisco', 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-gradient);
      min-height: 100vh;
      padding: 24px;
      transition: background 0.6s ease, color 0.3s ease;
      color: var(--text-main);
      position: relative;
      overflow-x: hidden;
    }

    body::before, body::after {
      content: '';
      position: fixed;
      width: 420px;
      height: 420px;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, transparent 65%);
      top: -160px;
      border-radius: 50%;
      z-index: -2;
      pointer-events: none;
      transition: opacity 0.6s ease;
    }

    body::after {
      top: auto;
      bottom: -220px;
      right: -120px;
      left: auto;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.16) 0%, transparent 70%);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 28px;
      align-items: start;
      position: relative;
      z-index: 1;
    }

    @media (max-width: 960px) { .container { grid-template-columns: repeat(6, 1fr); } }
    @media (max-width: 720px) { body { padding: 16px; } .container { grid-template-columns: repeat(1, minmax(0, 1fr)); gap: 18px; } }

    .card {
      background: var(--card-bg);
      border-radius: 26px;
      padding: 34px;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--card-border);
      transition: transform 0.35s ease, box-shadow 0.35s ease, border-color 0.3s ease;
      backdrop-filter: blur(12px);
    }

    .card:hover { transform: translateY(-6px); box-shadow: 0 18px 48px rgba(26, 62, 102, 0.18); }

    .container > .card:not(.header) { grid-column: span 6; }
    .card.card--full { grid-column: 1 / -1; }
    @media (max-width: 960px) { .container > .card:not(.header) { grid-column: span 6; } }
    @media (max-width: 720px) { .container > .card:not(.header) { grid-column: 1 / -1; } }

    .header {
      text-align: center;
      margin-bottom: 20px;
      grid-column: 1 / -1;
      background: linear-gradient(135deg, rgba(74, 144, 226, 0.12), rgba(135, 206, 250, 0.08));
      border: 1px solid rgba(74, 144, 226, 0.2);
      position: relative;
      overflow: hidden;
    }

    .header::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 15% 20%, rgba(255, 255, 255, 0.35), transparent 55%),
        radial-gradient(circle at 85% 30%, rgba(116, 185, 255, 0.25), transparent 50%);
      opacity: 0.7;
      pointer-events: none;
    }

    .header h1 {
      font-size: clamp(2.6rem, 5vw, 3.4rem);
      color: var(--accent-strong);
      margin-bottom: 12px;
      font-weight: 700;
      letter-spacing: -0.02em;
      position: relative;
    }

    .header p { font-size: 1.2rem; color: var(--text-soft); font-weight: 400; position: relative; }

    .status-bar {
      position: fixed;
      top: 24px;
      right: 24px;
      background: var(--warning);
      color: #fff;
      padding: 12px 22px;
      border-radius: 999px;
      font-weight: 600;
      z-index: 1000;
      backdrop-filter: blur(10px);
      border: none;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12);
      letter-spacing: 0.01em;
    }

    .status-bar.connected { background: var(--success); }
    .status-bar.error { background: var(--danger); }
    .status-bar.demo { background: var(--warning); }

    .theme-toggle {
      position: fixed;
      top: 24px;
      left: 24px;
      background: rgba(255, 255, 255, 0.88);
      border: none;
      border-radius: 50%;
      width: 52px;
      height: 52px;
      font-size: 1.5rem;
      cursor: pointer;
      backdrop-filter: blur(14px);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      z-index: 1000;
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    body.dark-mode .theme-toggle { background: rgba(38, 52, 68, 0.9); }
    .theme-toggle:hover { transform: translateY(-3px); box-shadow: 0 18px 32px rgba(0, 0, 0, 0.18); }

    .section-title {
      font-size: 1.5rem;
      color: var(--accent-strong);
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    .microphone-section { text-align: center; }

    .microphone-button {
      width: 126px;
      height: 126px;
      border-radius: 50%;
      background: linear-gradient(145deg, var(--accent), var(--accent-strong));
      border: none;
      color: #fff;
      font-size: 2.5rem;
      cursor: pointer;
      margin: 22px auto;
      display: grid;
      place-items: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      box-shadow: 0 18px 35px rgba(74, 144, 226, 0.35);
      position: relative;
      overflow: hidden;
    }

    .microphone-button::after {
      content: '';
      position: absolute;
      inset: 15%;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.16);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .microphone-button:hover { transform: translateY(-4px) scale(1.03); box-shadow: 0 24px 42px rgba(74, 144, 226, 0.45); }
    .microphone-button:hover::after { opacity: 1; }

    .microphone-button.listening {
      background: linear-gradient(145deg, #ff5f6d, #d32f2f);
      animation: pulse 2s infinite;
      box-shadow: 0 18px 38px rgba(211, 47, 47, 0.35);
    }

    .microphone-button.disabled {
      background: linear-gradient(135deg, #b0bec5, #90a4ae);
      box-shadow: 0 12px 22px rgba(120, 144, 156, 0.25);
      animation: none;
      cursor: not-allowed;
    }

    @keyframes pulse { 0% { transform: translateY(0) scale(1); } 50% { transform: translateY(-3px) scale(1.07); } 100% { transform: translateY(0) scale(1); } }

    .microphone-status {
      background: var(--accent-soft);
      border: 1px solid rgba(74, 144, 226, 0.28);
      border-radius: 20px;
      padding: 16px 20px;
      margin: 22px 0;
      font-weight: 600;
      color: var(--accent-strong);
      transition: background 0.3s ease, border-color 0.3s ease, color 0.3s ease;
    }

    .microphone-status.active { background: rgba(46, 204, 113, 0.12); border-color: rgba(46, 204, 113, 0.35); color: var(--success); }
    .microphone-status.disabled { background: rgba(149, 165, 166, 0.14); border-color: rgba(149, 165, 166, 0.25); color: #95a5a6; }

    .transcript-area {
      background: rgba(248, 249, 252, 0.86);
      border: 2px dashed rgba(74, 144, 226, 0.28);
      border-radius: 18px;
      padding: 22px;
      min-height: 110px;
      margin: 22px 0;
      font-style: italic;
      color: var(--text-soft);
      transition: background 0.3s ease, border-color 0.3s ease, color 0.3s ease;
    }

    .transcript-area.has-content { background: rgba(74, 144, 226, 0.06); border-color: rgba(74, 144, 226, 0.45); color: var(--text-main); font-style: normal; }

    .microphone-help {
      background: rgba(255, 193, 7, 0.08);
      border: 1px solid rgba(255, 193, 7, 0.28);
      border-radius: 18px;
      padding: 18px;
      margin: 18px 0;
      font-size: 0.95rem;
      line-height: 1.6;
      color: var(--text-soft);
    }

    .microphone-help h4 { color: #ffb74d; margin-bottom: 12px; font-weight: 600; }
    .microphone-help li { margin: 6px 0; }

    .chat-section { display: flex; flex-direction: column; height: 600px; }

    .chat-container {
      flex: 1;
      background: rgba(248, 249, 250, 0.7);
      border-radius: 22px;
      padding: 24px;
      overflow-y: auto;
      margin-bottom: 22px;
      border: 1px solid rgba(74, 144, 226, 0.12);
      position: relative;
    }

    .message {
      margin: 16px 0;
      padding: 16px 22px;
      border-radius: 24px;
      max-width: 80%;
      word-wrap: break-word;
      animation: fadeIn 0.25s ease;
      box-shadow: 0 12px 24px rgba(15, 33, 54, 0.06);
      line-height: 1.55;
      letter-spacing: 0.01em;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .message.user { background: linear-gradient(135deg, var(--accent-strong), var(--accent)); color: #fff; margin-left: auto; border-bottom-right-radius: 8px; }
    .message.assistant { background: rgba(255, 255, 255, 0.92); color: var(--text-main); margin-right: auto; border-bottom-left-radius: 8px; border: 1px solid rgba(74, 144, 226, 0.14); }

    body.dark-mode .chat-container { background: rgba(28, 38, 53, 0.75); border-color: rgba(116, 185, 255, 0.12); }
    body.dark-mode .message.assistant { background: rgba(33, 45, 60, 0.95); border-color: rgba(116, 185, 255, 0.18); }

    .typing-indicator {
      display: none;
      align-items: center;
      gap: 12px;
      padding: 16px 22px;
      background: rgba(255, 255, 255, 0.92);
      border-radius: 22px;
      border-bottom-left-radius: 8px;
      max-width: 70%;
      margin: 16px 0;
      border: 1px solid rgba(74, 144, 226, 0.18);
      box-shadow: 0 10px 24px rgba(15, 33, 54, 0.08);
      color: var(--text-soft);
    }

    body.dark-mode .typing-indicator { background: rgba(37, 49, 66, 0.95); border-color: rgba(116, 185, 255, 0.18); }

    .typing-dots { display: flex; gap: 5px; }
    .typing-dots span { width: 9px; height: 9px; background: var(--accent); border-radius: 50%; animation: typing 1.4s infinite ease-in-out; }
    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes typing { 0%, 80%, 100% { transform: scale(0.75); opacity: 0.4; } 40% { transform: scale(1); opacity: 1; } }

    .chat-input-container { display: flex; gap: 12px; align-items: center; }

    .chat-input {
      flex: 1;
      padding: 16px 20px;
      border: 2px solid rgba(255, 193, 7, 0.35);
      border-radius: 999px;
      font-size: 1rem;
      outline: none;
      transition: border-color 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
      background: rgba(255, 255, 255, 0.92);
      color: var(--text-main);
    }

    .chat-input:focus { border-color: rgba(74, 144, 226, 0.65); box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.1); }
    body.dark-mode .chat-input { background: rgba(33, 45, 60, 0.92); border-color: rgba(127, 140, 141, 0.5); color: #f8fbff; }

    .send-button {
      background: linear-gradient(135deg, var(--accent-strong), var(--accent));
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 54px;
      height: 54px;
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      box-shadow: 0 16px 32px rgba(74, 144, 226, 0.35);
    }

    .send-button:hover { transform: translateY(-3px); box-shadow: 0 20px 38px rgba(74, 144, 226, 0.45); }

    .privacy-button {
      background: rgba(255, 149, 0, 0.12);
      border: 1px solid rgba(255, 149, 0, 0.35);
      color: var(--warning);
      padding: 16px 34px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      margin: 16px auto;
      display: block;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      text-align: center;
      grid-column: 1 / -1;
    }

    .privacy-button:hover { transform: translateY(-3px); box-shadow: 0 12px 28px rgba(255, 149, 0, 0.28); }

    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(5, 14, 26, 0.65);
      z-index: 2000;
      backdrop-filter: blur(8px);
      padding: 24px;
    }

    .modal-content {
      background: var(--card-bg);
      margin: 3% auto;
      padding: 32px;
      border-radius: 24px;
      width: min(640px, 92vw);
      max-height: 82vh;
      overflow-y: auto;
      position: relative;
      animation: modalSlideIn 0.35s ease;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--card-border);
    }

    @keyframes modalSlideIn { from { transform: translateY(-40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .close { position: absolute; top: 18px; right: 22px; font-size: 2rem; cursor: pointer; color: rgba(149, 165, 166, 0.8); transition: color 0.3s ease; }
    .close:hover { color: var(--danger); }

    .emergency-section { background: rgba(231, 76, 60, 0.08); border: 1px solid rgba(231, 76, 60, 0.25); border-radius: 18px; padding: 22px; margin: 22px 0; }
    .emergency-section h3 { color: var(--danger); margin-bottom: 16px; }
    .emergency-section p { color: rgba(211, 47, 47, 0.85); font-weight: 600; margin-bottom: 10px; }

    .privacy-section { background: rgba(46, 204, 113, 0.08); border: 1px solid rgba(46, 204, 113, 0.25); border-radius: 18px; padding: 22px; margin: 22px 0; color: var(--text-soft); }
    .privacy-section h3 { color: var(--success); margin-bottom: 16px; }

    .quote { text-align: center; font-style: italic; color: var(--text-soft); margin: 32px 0 12px; font-size: 1.1rem; }

    .admin-button {
      display: none;
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: linear-gradient(135deg, rgba(38, 52, 68, 0.92), rgba(54, 71, 92, 0.92));
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 62px;
      height: 62px;
      font-size: 1.5rem;
      cursor: pointer;
      backdrop-filter: blur(14px);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      z-index: 1000;
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.35);
    }

    .admin-button:hover { transform: translateY(-3px) scale(1.04); box-shadow: 0 18px 38px rgba(15, 23, 42, 0.45); }

    .admin-form { display: flex; flex-direction: column; gap: 22px; margin-top: 28px; }
    .admin-form label { font-weight: 600; color: var(--text-main); letter-spacing: 0.01em; }
    .admin-form input, .admin-form select { padding: 13px 16px; border: 1px solid rgba(149, 165, 166, 0.35); border-radius: 12px; font-size: 1rem; outline: none; transition: border-color 0.3s ease, box-shadow 0.3s ease; background: rgba(255, 255, 255, 0.9); color: var(--text-main); }
    .admin-form input:focus, .admin-form select:focus { border-color: rgba(74, 144, 226, 0.55); box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.12); }
    .admin-form button { background: linear-gradient(135deg, var(--accent-strong), var(--accent)); color: #fff; border: none; padding: 15px 30px; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .admin-form button:hover { transform: translateY(-3px); box-shadow: 0 16px 32px rgba(74, 144, 226, 0.35); }

    .toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) translateY(20px); background: rgba(46, 204, 113, 0.95); color: #fff; padding: 20px 30px; border-radius: 15px; font-weight: bold; z-index: 3000; opacity: 0; transition: all 0.3s ease; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); text-align: center; max-width: 80%; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2); }
    .toast.error { background: rgba(244, 67, 54, 0.95); }
    .toast.show { opacity: 1; transform: translate(-50%, -50%) translateY(0); }

    .card ol { color: var(--text-soft); line-height: 1.6; margin-left: 18px; }
    body.dark-mode .card ol { color: #d5dde5; }

    .emergency-footer {
      grid-column: 1 / -1;
      background: rgba(231, 76, 60, 0.08);
      border: 1px solid rgba(231, 76, 60, 0.22);
      border-radius: 24px;
      padding: 34px;
      margin-top: 30px;
    }

    .emergency-footer h2 { color: var(--danger); text-align: center; margin-bottom: 25px; font-size: 1.8rem; letter-spacing: 0.01em; }

    .country-section { margin: 20px 0; padding: 18px; background: rgba(255, 255, 255, 0.7); border-radius: 18px; border-left: 5px solid rgba(244, 67, 54, 0.65); }
    body.dark-mode .country-section { background: rgba(33, 45, 60, 0.72); }
    .country-section h3 { color: var(--danger); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }

    .contact-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
    .contact-item { background: rgba(231, 76, 60, 0.05); padding: 12px 16px; border-radius: 12px; border: 1px solid rgba(231, 76, 60, 0.2); transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .contact-item:hover { background: rgba(231, 76, 60, 0.1); transform: translateY(-2px); box-shadow: 0 10px 18px rgba(244, 67, 54, 0.18); }
    .contact-item strong { color: var(--danger); }

    .chat-container::-webkit-scrollbar { width: 8px; }
    .chat-container::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.05); border-radius: 10px; }
    .chat-container::-webkit-scrollbar-thumb { background: rgba(74, 144, 226, 0.6); border-radius: 10px; }
    .chat-container::-webkit-scrollbar-thumb:hover { background: rgba(74, 144, 226, 0.8); }

    @media (max-width: 480px) {
      .card { padding: 24px; }
      .header h1 { font-size: 2.4rem; }
      .microphone-button { width: 108px; height: 108px; font-size: 2.2rem; }
      .chat-section { height: 520px; }
      .message { max-width: 92%; }
      .contact-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <button class="theme-toggle" id="themeToggle">🌙</button>
  <div class="status-bar demo" id="statusBar">⏳ Avvio…</div>
  <button class="admin-button" id="adminBtn">⚙️</button>

  <div class="container">
    <div class="header card">
      <h1>AluIA</h1>
      <p>Supporto psicologico intelligente sempre al tuo fianco</p>
    </div>

    <div class="card">
      <h2 class="section-title">🎤 Comunicazione Vocale</h2>
      <div class="microphone-section">
        <button class="microphone-button" id="microphoneButton">🎤</button>
        <div class="microphone-status" id="microphoneStatus">Microfono pronto ad ascoltarti</div>
        <div class="transcript-area" id="transcriptArea">La trascrizione in tempo reale apparirà qui...</div>
        <div class="microphone-help">
          <h4>🔓 Come sbloccare il microfono:</h4>
          <ol>
            <li>Usa la pagina in <strong>HTTPS</strong></li>
            <li>Clicca sull'icona del lucchetto 🔒 e consenti il microfono</li>
            <li>Ricarica la pagina (F5) se richiesto</li>
          </ol>
        </div>
      </div>
    </div>

    <div class="card card--full">
      <h2 class="section-title">💬 Chat con Alu</h2>
      <div class="chat-section">
        <div class="chat-container" id="chatContainer">
          <div class="message assistant">
            👋 Ciao! Sono Alu e sono qui per aiutarti. Puoi parlarmi vocalmente premendo il microfono o scrivere qui nella chat. Come posso supportarti oggi?
          </div>
          <div class="typing-indicator" id="typingIndicator">
            <span>Alu sta scrivendo</span>
            <div class="typing-dots"><span></span><span></span><span></span></div>
          </div>
        </div>
        <div class="chat-input-container">
          <input type="text" class="chat-input" id="chatInput" placeholder="Scrivi il tuo messaggio...">
          <button class="send-button" id="sendButton">Invia</button>
        </div>
      </div>
    </div>

    <button class="privacy-button" id="privacyButton">🔒 Privacy & Sicurezza</button>

    <div class="emergency-footer">
      <h2>🆘 CONTATTI DI EMERGENZA</h2>
      <div class="country-section">
        <h3>🇮🇹 ITALIA</h3>
        <div class="contact-grid">
          <div class="contact-item">📞 <strong>Telefono Amico:</strong> 800.833.833</div>
          <div class="contact-item">🌍 <strong>Dall'estero:</strong> +39 02 20228733</div>
          <div class="contact-item">🚨 <strong>Numero Unico Emergenza:</strong> 112</div>
          <div class="contact-item">🛡️ <strong>Antiviolenza e Stalking:</strong> 1522</div>
          <div class="contact-item">❤️ <strong>Croce Rossa Emergenza Psicologica:</strong> 1520</div>
        </div>
      </div>
      <div class="country-section">
        <h3>🇵🇹 PORTOGALLO</h3>
        <div class="contact-grid">
          <div class="contact-item">🏥 <strong>SNS 24:</strong> 808 24 24 24 (opzione 4)</div>
          <div class="contact-item">🆘 <strong>APAV:</strong> 116 006</div>
          <div class="contact-item">🚨 <strong>Emergenza UE:</strong> 112</div>
          <div class="contact-item">💚 <strong>SOS Voz Amiga:</strong> 213 544 545</div>
          <div class="contact-item">🤝 <strong>Conversa Amiga:</strong> 925 512 884</div>
          <div class="contact-item">📞 <strong>Telefone da Amizade:</strong> 228 323 535</div>
        </div>
      </div>
      <div class="country-section">
        <h3>🇬🇧 REGNO UNITO</h3>
        <div class="contact-grid">
          <div class="contact-item">🚨 <strong>Emergenze:</strong> 999</div>
          <div class="contact-item">🛡️ <strong>Domestic Abuse Helpline:</strong> 0808 2000 247</div>
          <div class="contact-item">💙 <strong>Samaritans:</strong> 116 123</div>
          <div class="contact-item">👶 <strong>Childline:</strong> 0800 1111</div>
        </div>
      </div>
      <div class="country-section">
        <h3>🇪🇸 SPAGNA</h3>
        <div class="contact-grid">
          <div class="contact-item">🚨 <strong>Emergenza Generale:</strong> 112</div>
          <div class="contact-item">🧠 <strong>Supporto Psicologico 24h:</strong> 800 101 800</div>
          <div class="contact-item">🛡️ <strong>Violenza di Genere:</strong> 016</div>
          <div class="contact-item">💚 <strong>Telefono della Speranza:</strong> 717 003 717</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Privacy Modal -->
  <div class="modal" id="privacyModal">
    <div class="modal-content">
      <span class="close" id="closePrivacy">&times;</span>
      <h2>🔒 Privacy & Sicurezza</h2>
      <div class="emergency-section">
        <h3>🆘 CONTATTI DI EMERGENZA</h3>
        <p>⚠️ IMPORTANTE: AluIA non sostituisce il supporto psicologico professionale.</p>
        <p>In caso di emergenze, contatta immediatamente un professionista qualificato o i servizi di emergenza.</p>
      </div>
      <div class="privacy-section">
        <h3>🔒 Privacy Garantita</h3>
        <p><strong>Tutte le conversazioni sono completamente private e sicure.</strong> I tuoi dati non vengono mai condivisi o salvati sui nostri server.</p>
        <ul>
          <li>✅ Nessun salvataggio permanente delle conversazioni</li>
          <li>✅ Comunicazione crittografata</li>
          <li>✅ Nessuna condivisione con terze parti</li>
          <li>✅ Anonimato garantito</li>
          <li>✅ Dati processati localmente nel browser</li>
          <li>✅ Nessun tracking o profilazione</li>
        </ul>
      </div>
      <div class="quote">💙 "Quando vuoi, sono qui per ascoltarti sempre." - Alu</div>
    </div>
  </div>

  <!-- Admin Config Modal -->
  <div class="modal" id="adminModal">
    <div class="modal-content">
      <span class="close" id="closeAdmin">&times;</span>
      <h2>⚙️ Configurazione Amministratore</h2>
      <div class="admin-form">
        <label for="assistantId">Assistant ID (opzionale):</label>
        <input type="text" id="assistantId" placeholder="asst_...">
        <label for="promptId">Prompt ID (opzionale):</label>
        <input type="text" id="promptId" placeholder="pmpt_...">
        <label for="voiceId">Voce OpenAI TTS:</label>
        <select id="voiceId">
          <option value="nova" selected>Nova (femminile calda - consigliata)</option>
          <option value="alloy">Alloy (neutrale)</option>
          <option value="echo">Echo (maschile)</option>
          <option value="fable">Fable (maschile britannico)</option>
          <option value="onyx">Onyx (maschile profondo)</option>
          <option value="shimmer">Shimmer (femminile delicata)</option>
        </select>
        <button onclick="window.aluia.saveAdminConfig()">Salva Configurazione</button>
      </div>
    </div>
  </div>

  <script>
    console.log('🚀 Avvio AluIA - Versione OpenAI TTS');
    const DEFAULT_PROMPT_ID = 'pmpt_68b5876fea1081908e6b472c85d6489a042e34dea2f3df83';

    function isSecureLikeContext(){
      const {protocol, hostname} = location;
      return protocol === 'https:' || hostname === 'localhost' || hostname === '127.0.0.1';
    }

    const ADMIN_UNLOCK_CODE = 'ALUIA2025';

    class AluIA {
      constructor() {
        this.recognition = null;
        this.isListening = false;
        this.isProcessing = false;
        this.autoRestartEnabled = true;
        this.restartTimeout = null;
        this.conversationHistory = [];
        this.isDarkMode = localStorage.getItem('aluia_theme') === 'dark';
        this.assistantId = localStorage.getItem('aluia_assistant_id') || '';
        this.voiceId = localStorage.getItem('aluia_voice_id') || 'nova';
        const storedPromptId = localStorage.getItem('aluia_prompt_id');
        this.promptId = storedPromptId && storedPromptId.trim()
          ? storedPromptId.trim()
          : DEFAULT_PROMPT_ID;
        this.microphoneEnabled = true;
        this.adminUnlocked = localStorage.getItem('aluia_admin_unlocked') === 'true';

        this.isSpeaking = false;
        this.ignoreAsrUntil = 0;
        this.postTtsCooldownMs = 900;
        this.hasPendingRequest = false;
        this.demoNoticeShown = false;

        this.desktopFix = {
          maxRetries: 5, currentRetries: 0, isDesktop: !this.isMobileDevice(),
          lastError: null, errorCount: 0, consecutiveErrors: 0,
          lastSuccessTime: Date.now(), adaptiveDelay: 1500
        };

        this.initElements();
        this.initSpeechRecognition();
        this.initEventListeners();
        this.applyTheme();
        this.initVoicesOnce();

        this.setStatus('demo', '⏳ Avvio…');
        if (this.adminUnlocked && this.adminBtn) {
          this.adminBtn.style.display = 'block';
        }
        setTimeout(() => { this.startAutoListening(); }, 1000);
      }

      setStatus(kind, text) {
        if (!this.statusBar) return;
        this.statusBar.classList.remove('connected', 'error', 'demo');
        if (kind) this.statusBar.classList.add(kind);
        const defaultText = kind === 'connected'
          ? '✅ Connesso a OpenAI'
          : kind === 'error'
            ? '❌ Errore di connessione'
            : '⚠️ Modalità Demo';
        this.statusBar.textContent = text || defaultText;
      }

      isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
          (navigator.maxTouchPoints && navigator.maxTouchPoints > 2);
      }

      initElements() {
        this.microphoneButton = document.getElementById('microphoneButton');
        this.microphoneStatus = document.getElementById('microphoneStatus');
        this.transcriptArea = document.getElementById('transcriptArea');
        this.chatContainer = document.getElementById('chatContainer');
        this.chatInput = document.getElementById('chatInput');
        this.sendButton = document.getElementById('sendButton');
        this.typingIndicator = document.getElementById('typingIndicator');
        this.statusBar = document.getElementById('statusBar');
        this.themeToggle = document.getElementById('themeToggle');
        this.adminBtn = document.getElementById('adminBtn');
        this.privacyModal = document.getElementById('privacyModal');
        this.adminModal = document.getElementById('adminModal');
        this.statusBar?.setAttribute('aria-live', 'polite');
      }

      initSpeechRecognition() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          this.recognition = new SpeechRecognition();
          this.recognition.continuous = true;
          this.recognition.interimResults = true;
          this.recognition.lang = 'it-IT';
          this.recognition.maxAlternatives = 1;

          try { this.recognition.grammars = new (window.SpeechGrammarList || window.webkitSpeechGrammarList)(); } catch (e) { }

          this.recognition.onstart = () => {
            this.isListening = true;
            this.desktopFix.currentRetries = 0;
            this.desktopFix.consecutiveErrors = 0;
            this.desktopFix.lastSuccessTime = Date.now();
            this.updateMicrophoneUI();
          };

          this.recognition.onresult = (event) => {
            if (this.isSpeaking || Date.now() < this.ignoreAsrUntil) return;
            let finalTranscript = '', interimTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
              const transcript = event.results[i][0].transcript;
              if (event.results[i].isFinal) finalTranscript += transcript; else interimTranscript += transcript;
            }
            this.transcriptArea.textContent = finalTranscript + interimTranscript;
            this.transcriptArea.classList.add('has-content');
            if (finalTranscript.trim()) {
              this.desktopFix.lastSuccessTime = Date.now();
              this.desktopFix.consecutiveErrors = 0;
              this.processVoiceInput(finalTranscript.trim());
            }
          };

          this.recognition.onerror = (event) => {
            this.desktopFix.lastError = event.error;
            this.desktopFix.errorCount++;
            this.desktopFix.consecutiveErrors++;
            this.handleSpeechErrorAdvanced(event.error);
          };

          this.recognition.onend = () => {
            this.isListening = false;
            this.updateMicrophoneUI();
            if (this.autoRestartEnabled && !this.isProcessing && this.microphoneEnabled && !this.isSpeaking) {
              this.scheduleSmartRestart();
            }
          };
        } else {
          this.showToast('Riconoscimento vocale non supportato in questo browser', 'error');
        }
      }

      handleSpeechErrorAdvanced(error) {
        if (this.restartTimeout) clearTimeout(this.restartTimeout);
        let restartDelay = this.desktopFix.adaptiveDelay;
        let shouldRestart = true;

        if (this.desktopFix.consecutiveErrors > 2) {
          restartDelay = Math.min(8000, this.desktopFix.adaptiveDelay * Math.pow(1.5, this.desktopFix.consecutiveErrors - 2));
        }
        switch (error) {
          case 'not-allowed':
            this.autoRestartEnabled = false; shouldRestart = false;
            this.showToast('Permessi microfono negati. Clicca il microfono per riprovare.', 'error'); break;
          case 'audio-capture':
            if (this.desktopFix.consecutiveErrors > 2) { shouldRestart = false; this.showToast('Problema con il microfono. Controlla le impostazioni.', 'error'); }
            else restartDelay = 3000; break;
          default: break;
        }
        const timeSinceSuccess = Date.now() - this.desktopFix.lastSuccessTime;
        if (timeSinceSuccess > 60000 && this.desktopFix.consecutiveErrors > 3) shouldRestart = false;

        if (shouldRestart && this.autoRestartEnabled && this.microphoneEnabled && !this.isSpeaking) {
          this.restartTimeout = setTimeout(() => {
            if (this.autoRestartEnabled && !this.isListening && this.microphoneEnabled && !this.isSpeaking) {
              this.startListening();
            }
          }, restartDelay);
        }
        this.isListening = false;
        this.updateMicrophoneUI();
      }

      scheduleSmartRestart() {
        let delay = this.desktopFix.isDesktop ? 2500 : 1500;
        if (this.desktopFix.consecutiveErrors > 0) delay += this.desktopFix.consecutiveErrors * 500;
        delay = Math.min(delay, 6000);
        this.restartTimeout = setTimeout(() => {
          if (this.autoRestartEnabled && !this.isListening && !this.isProcessing && this.microphoneEnabled && !this.isSpeaking) {
            this.startListening();
          }
        }, delay);
      }

      initEventListeners() {
        this.microphoneButton?.addEventListener('click', () => this.toggleMicrophone());
        this.sendButton?.addEventListener('click', () => this.sendMessage());
        this.chatInput?.addEventListener('keypress', (e) => { if (e.key === 'Enter') this.sendMessage(); });
        this.themeToggle?.addEventListener('click', () => this.toggleTheme());

        document.getElementById('privacyButton')?.addEventListener('click', () => this.showPrivacyModal());
        document.getElementById('closePrivacy')?.addEventListener('click', () => this.hidePrivacyModal());
        document.getElementById('closeAdmin')?.addEventListener('click', () => this.hideAdminModal());

        document.addEventListener('click', (e) => {
          if (e.target === this.privacyModal) this.hidePrivacyModal();
          if (e.target === this.adminModal) this.hideAdminModal();
        });
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') { this.hidePrivacyModal(); this.hideAdminModal(); }
        });
        document.addEventListener('dblclick', (e) => {
          if (e.target === document.body) {
            const code = prompt('Codice amministratore:');
            if ((code || '').trim() === ADMIN_UNLOCK_CODE) {
              this.adminUnlocked = true;
              localStorage.setItem('aluia_admin_unlocked', 'true');
              this.adminBtn.style.display = 'block';
              this.showToast('Modalità amministratore attivata', 'success');
            }
          }
        });
        this.adminBtn?.addEventListener('click', () => this.showAdminModal());

        document.addEventListener('visibilitychange', () => {
          if (document.hidden) {
            if (this.isListening) { this.autoRestartEnabled = false; this.stopListening(); }
          } else {
            setTimeout(() => {
              this.autoRestartEnabled = true; this.desktopFix.consecutiveErrors = 0;
              if (!this.isListening && this.microphoneEnabled && !this.isSpeaking) { this.startListening(); }
            }, 1000);
          }
        });
      }

      async startAutoListening() {
        try {
          if (!isSecureLikeContext()) {
            this.showToast('Apri la pagina in HTTPS o localhost per attivare il microfono', 'error');
            return;
          }
          const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true } });
          stream.getTracks().forEach(t => t.stop());
          setTimeout(() => { if (this.microphoneEnabled) this.startListening(); }, this.desktopFix.isDesktop ? 2000 : 1000);
        } catch (error) {
          this.showToast('Permessi microfono richiesti per funzionare', 'error');
        }
      }

      startListening() {
        if (this.recognition && !this.isListening && this.microphoneEnabled) {
          try { this.recognition.start(); }
          catch (error) {
            this.desktopFix.consecutiveErrors++;
            const retryDelay = this.desktopFix.isDesktop ? 3000 : 2000;
            setTimeout(() => {
              if (!this.isListening && this.autoRestartEnabled && this.desktopFix.consecutiveErrors < 5 && this.microphoneEnabled && !this.isSpeaking) {
                this.startListening();
              }
            }, retryDelay);
          }
        }
      }

      stopListening() {
        if (this.recognition && this.isListening) {
          this.recognition.stop();
          if (this.restartTimeout) { clearTimeout(this.restartTimeout); this.restartTimeout = null; }
        }
      }

      toggleMicrophone() {
        if (this.microphoneEnabled) {
          this.microphoneEnabled = false; this.autoRestartEnabled = false; this.stopListening();
          this.showToast('Microfono disattivato', 'error');
        } else {
          this.microphoneEnabled = true; this.autoRestartEnabled = true;
          this.desktopFix.currentRetries = 0; this.desktopFix.consecutiveErrors = 0;
          this.startListening(); this.showToast('Microfono attivato', 'success');
        }
        this.updateMicrophoneUI();
      }

      updateMicrophoneUI() {
        if (!this.microphoneEnabled) {
          this.microphoneButton.classList.remove('listening');
          this.microphoneButton.classList.add('disabled');
          this.microphoneStatus.textContent = 'Microfono disattivato - Clicca per attivare';
          this.microphoneStatus.classList.remove('active');
          this.microphoneStatus.classList.add('disabled');
        } else if (this.isListening) {
          this.microphoneButton.classList.add('listening');
          this.microphoneButton.classList.remove('disabled');
          this.microphoneStatus.textContent = 'Microfono attivo - Parla ora';
          this.microphoneStatus.classList.add('active');
          this.microphoneStatus.classList.remove('disabled');
        } else {
          this.microphoneButton.classList.remove('listening', 'disabled');
          this.microphoneStatus.textContent = 'Microfono pronto ad ascoltarti';
          this.microphoneStatus.classList.remove('active', 'disabled');
        }
      }

      pauseRecognition() {
        this.wasListeningPreTts = this.isListening;
        if (this.isListening) this.stopListening();
        this.resumeAfterTts = true;
      }
      resumeRecognitionSafe() {
        setTimeout(() => {
          if (this.resumeAfterTts && this.wasListeningPreTts) {
            if (this.microphoneEnabled && !this.isListening) this.startListening();
          }
          this.resumeAfterTts = false; this.wasListeningPreTts = false;
        }, this.postTtsCooldownMs);
      }

      processVoiceInput(text) {
        if (this.hasPendingRequest) {
          this.showToast('Attendi la risposta di Alu prima di parlare di nuovo', 'error');
          return;
        }
        this.isProcessing = true;
        this.addMessage(text, 'user');
        this.sendToAssistant(text).finally(() => { this.isProcessing = false; });
      }

      addMessage(content, type) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        messageDiv.textContent = content;
        this.chatContainer.appendChild(messageDiv);
        this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
      }

      sendMessage() {
        const message = this.chatInput.value.trim();
        if (message) {
          if (this.hasPendingRequest) {
            this.showToast('Attendi la risposta di Alu prima di inviare un nuovo messaggio', 'error');
            return;
          }
          this.addMessage(message, 'user');
          this.chatInput.value = '';
          this.sendToAssistant(message);
        }
      }

      async sendToAssistant(message) {
        this.hasPendingRequest = true;
        this.isProcessing = true;
        this.showTyping();
        try {
          this.conversationHistory.push({ role: 'user', content: message });

          let edvResult;
          if (window.EDV && EDV.chat) {
            edvResult = await EDV.chat({
              messages: this.conversationHistory.slice(-10),
              assistantId: this.assistantId || undefined,
              promptId: this.promptId ? this.promptId : undefined
            });
          } else {
            const res = await fetch('/api/chat', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
              body: JSON.stringify({
                messages: this.conversationHistory.slice(-10),
                assistantId: this.assistantId || undefined,
                promptId: this.promptId ? this.promptId : undefined
              })
            });
            if (!res.ok) throw new Error('API Error ' + res.status);
            const data = await res.json();
            edvResult = {
              raw: data,
              content: data?.content ?? data?.message ?? data?.reply ??
                (Array.isArray(data?.choices) ? data.choices?.[0]?.message?.content : undefined)
            };
          }

          const normalized = this.normalizeAssistantResponse(edvResult, message);
          const response = normalized.text;

          if (normalized.hasError) {
            this.setStatus('error', normalized.statusText || '❌ Errore di connessione');
            if (normalized.statusText) {
              this.showToast(normalized.statusText, 'error');
            }
          } else if (normalized.isDemo) {
            this.setStatus('demo', normalized.statusText || '⚠️ Modalità Demo');
            if (normalized.statusText && !this.demoNoticeShown) {
              this.showToast(normalized.statusText, 'error');
              this.demoNoticeShown = true;
            }
          } else {
            this.setStatus('connected', '✅ Connesso a OpenAI');
            this.demoNoticeShown = false;
          }

          this.conversationHistory.push({ role: 'assistant', content: response });
          this.addMessage(response, 'assistant');
          this.hideTyping();

          this.ignoreAsrUntil = Date.now() + 2000;

          if (normalized.hasError || normalized.isDemo) {
            this.speakWithNativeTTS(response);
          } else {
            await this.speakWithOpenAI(response);
          }

          if (this.conversationHistory.length > 40) {
            this.conversationHistory = this.conversationHistory.slice(-20);
          }
        } catch (err) {
          console.warn('sendToAssistant error:', err);
          this.hideTyping();
          const fallback = this.getDemoResponse(message);
          this.conversationHistory.push({ role: 'assistant', content: fallback });
          this.addMessage(fallback, 'assistant');
          this.ignoreAsrUntil = Date.now() + 2000;
          this.speakWithNativeTTS(fallback);
          this.setStatus('error', '❌ Errore di connessione');
          this.showToast('Errore di rete o endpoint non raggiungibile', 'error');
          this.demoNoticeShown = false;
        } finally {
          this.hideTyping();
          this.isProcessing = false;
          this.hasPendingRequest = false;
        }
      }

      normalizeAssistantResponse(edvResult, fallbackSource) {
        const raw = edvResult?.raw || {};
        const content = typeof edvResult?.content === 'string' ? edvResult.content.trim() : '';
        const text = content || this.getDemoResponse(fallbackSource);
        const statusText = raw?.error || raw?.warning || raw?.message || raw?.status || raw?.statusText || null;
        const isDemo = Boolean(raw?.warning || raw?.demo || raw?.mode === 'demo' || raw?.status === 'demo');
        const hasError = Boolean(raw?.error);
        return { text, raw, statusText, isDemo, hasError };
      }

      async speakWithOpenAI(text) {
        try {
          const cleanText = (text || '').replace(/[🔥💙✅❌⚠️🆘🎤💬🔒]/g, '').trim() || ' ';

          let audioBlob;
          if (window.EDV && EDV.tts) {
            audioBlob = await EDV.tts({ text: cleanText, voiceId: this.voiceId || undefined });
          } else {
            const res = await fetch('/api/tts', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ text: cleanText, voiceId: this.voiceId || undefined })
            });
            if (!res.ok) throw new Error('TTS API ' + res.status);
            audioBlob = await res.blob();
          }

          const url = URL.createObjectURL(audioBlob);
          const audio = new Audio(url);
          audio.volume = 0.8;

          audio.onplay = () => { this.isSpeaking = true; this.pauseRecognition(); };
          audio.onended = () => { URL.revokeObjectURL(url); this.isSpeaking = false; this.resumeRecognitionSafe(); };
          audio.onerror = () => {
            URL.revokeObjectURL(url);
            this.isSpeaking = false;
            this.resumeRecognitionSafe();
            this.speakWithNativeTTS(text);
          };

          await audio.play();
          this.setStatus('connected', '🔊 Voce OpenAI attiva');
        } catch (e) {
          console.warn('TTS error, uso voce nativa:', e);
          this.speakWithNativeTTS(text);
          this.showToast('Voce OpenAI non disponibile: uso quella di sistema', 'error');
        }
      }

      initVoicesOnce() {
        if (!('speechSynthesis' in window)) return;
        const assign = () => {
          const voices = speechSynthesis.getVoices();
          const it = voices.find(v => v.lang && v.lang.toLowerCase().startsWith('it'));
          this._italianVoice = it || null;
        };
        assign();
        try { window.speechSynthesis.addEventListener('voiceschanged', assign, { once: true }); } catch { }
      }

      speakWithNativeTTS(text) {
        if (!('speechSynthesis' in window)) return;
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'it-IT'; u.rate = 0.85; u.pitch = 1.1; u.volume = 0.8;
        if (this._italianVoice) u.voice = this._italianVoice;
        u.onstart = () => { this.isSpeaking = true; this.pauseRecognition(); };
        u.onend = () => { this.isSpeaking = false; this.resumeRecognitionSafe(); };
        u.onerror = () => { this.isSpeaking = false; this.resumeRecognitionSafe(); };
        speechSynthesis.speak(u);
      }

      getDemoResponse(message) {
        const responses = [
          "Ti ascolto e capisco quello che stai vivendo. È normale sentirsi così a volte.",
          "Grazie per aver condiviso questo con me. Come ti senti ora dopo averlo espresso?",
          "Quello che provi è valido e importante. Vuoi parlarmi di più di questa situazione?",
          "Ti sono vicina in questo momento. Ricorda che non sei solo in questo percorso.",
          "È un passo importante quello di parlarne. Come posso aiutarti a sentirti meglio?",
          "Comprendo la tua preoccupazione. Insieme possiamo trovare delle strategie per affrontarla.",
          "Le tue emozioni sono importanti. Prenditi il tempo che ti serve per elaborarle.",
          "Sono qui per ascoltarti senza giudicare. Cosa ti passa per la mente in questo momento?",
          "Capisco che possa essere difficile. Vuoi provare a respirare insieme per qualche minuto?",
          "La tua esperienza è unica e preziosa. Come posso supportarti meglio oggi?"
        ];
        const lower = (message || '').toLowerCase();
        if (lower.includes('suicid') || lower.includes('morte') || lower.includes('farla finita')) {
          return "Mi preoccupo molto per te. È fondamentale che tu parli immediatamente con un professionista qualificato. Contatta il tuo medico, un centro di salute mentale o i servizi di emergenza. La tua vita ha un valore immenso e ci sono persone pronte ad aiutarti. 🆘";
        }
        if (lower.includes('panico') || lower.includes('ansia') || lower.includes('attacco')) {
          return "Capisco che stai attraversando un momento molto difficile. Proviamo insieme: inspira lentamente per 4 secondi, trattieni per 4, poi espira per 6. Ripeti. Se gli attacchi sono frequenti, confrontati con un professionista. 💙";
        }
        if (lower.includes('solo') || lower.includes('abbandon') || lower.includes('isolat')) {
          return "Non sei davvero solo, anche se ora può sembrare così. I sentimenti di solitudine sono dolorosi ma temporanei. Vuoi dirmi cosa ti fa sentire più isolato?";
        }
        return responses[Math.floor(Math.random() * responses.length)];
      }

      applyTheme() {
        if (this.isDarkMode) { document.body.classList.add('dark-mode'); this.themeToggle.textContent = '☀️'; }
        else { document.body.classList.remove('dark-mode'); this.themeToggle.textContent = '🌙'; }
      }
      toggleTheme() {
        this.isDarkMode = !this.isDarkMode;
        localStorage.setItem('aluia_theme', this.isDarkMode ? 'dark' : 'light');
        this.applyTheme();
        this.showToast(`Tema ${this.isDarkMode ? 'scuro' : 'chiaro'} attivato`);
      }

      showPrivacyModal() { this.privacyModal.style.display = 'block'; }
      hidePrivacyModal() { this.privacyModal.style.display = 'none'; }
      showAdminModal() {
        document.getElementById('assistantId').value = this.assistantId;
        document.getElementById('promptId').value = this.promptId;
        document.getElementById('voiceId').value = this.voiceId;
        this.adminModal.style.display = 'block';
      }
      hideAdminModal() { this.adminModal.style.display = 'none'; }

      saveAdminConfig() {
        const assistantId = document.getElementById('assistantId').value.trim();
        const promptId = document.getElementById('promptId').value.trim();
        const voiceId = document.getElementById('voiceId').value.trim();
        this.assistantId = assistantId;
        this.promptId = promptId || DEFAULT_PROMPT_ID;
        this.voiceId = voiceId || this.voiceId;
        localStorage.setItem('aluia_assistant_id', this.assistantId);
        localStorage.setItem('aluia_prompt_id', this.promptId);
        localStorage.setItem('aluia_voice_id', this.voiceId);
        this.hideAdminModal();
        this.showToast('Configurazione salvata', 'success');
      }

      showTyping() { this.typingIndicator.style.display = 'flex'; this.chatContainer.scrollTop = this.chatContainer.scrollHeight; }
      hideTyping() { this.typingIndicator.style.display = 'none'; }
      showToast(message, type = 'success') {
        const t = document.createElement('div');
        t.className = `toast ${type}`; t.textContent = message;
        document.body.appendChild(t);
        setTimeout(() => t.classList.add('show'), 100);
        setTimeout(() => { t.classList.remove('show'); setTimeout(() => { if (document.body.contains(t)) document.body.removeChild(t); }, 300); }, 4000);
      }
    }

    document.addEventListener('DOMContentLoaded', () => { window.aluia = new AluIA(); });

    window.testMic = () => window.aluia?.toggleMicrophone();
    window.testChat = () => { const a = window.aluia; if (!a) return; a.chatInput.value = "Ciao Alu, questo è un test"; a.sendMessage(); };
    window.debugMic = () => { const a = window.aluia; console.log({ isListening: a?.isListening, microphoneEnabled: a?.microphoneEnabled, isProcessing: a?.isProcessing, autoRestartEnabled: a?.autoRestartEnabled, isSpeaking: a?.isSpeaking }); };
    window.resetMic = () => { const a = window.aluia; if (!a) return; a.microphoneEnabled = true; a.autoRestartEnabled = true; a.stopListening(); setTimeout(() => { a.startListening(); a.showToast('Microfono resettato', 'success'); }, 1200); };
  </script>
</body>
</html>
